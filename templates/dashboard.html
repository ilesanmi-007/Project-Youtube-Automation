<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Automation Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .progress-bar {
            transition: width 0.5s ease;
        }
        .stage-dot {
            transition: all 0.3s ease;
        }
        .stage-dot.active {
            transform: scale(1.2);
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div class="container mx-auto p-6">
        <!-- Header -->
        <header class="mb-8">
            <h1 class="text-5xl font-bold mb-2 bg-gradient-to-r from-blue-500 to-purple-600 bg-clip-text text-transparent">
                üé¨ YouTube Automation Dashboard
            </h1>
            <p class="text-gray-400">Autonomous content creation pipeline - From idea to upload</p>
        </header>

        <!-- Stats Grid -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-gradient-to-br from-blue-600 to-blue-800 p-6 rounded-xl shadow-lg">
                <h3 class="text-blue-200 text-sm font-semibold mb-1">Total Videos</h3>
                <p class="text-4xl font-bold" id="total-videos">0</p>
            </div>
            <div class="bg-gradient-to-br from-green-600 to-green-800 p-6 rounded-xl shadow-lg">
                <h3 class="text-green-200 text-sm font-semibold mb-1">Ready to Upload</h3>
                <p class="text-4xl font-bold" id="ready-videos">0</p>
            </div>
            <div class="bg-gradient-to-br from-purple-600 to-purple-800 p-6 rounded-xl shadow-lg">
                <h3 class="text-purple-200 text-sm font-semibold mb-1">Total Views</h3>
                <p class="text-4xl font-bold" id="total-views">0</p>
            </div>
            <div class="bg-gradient-to-br from-pink-600 to-pink-800 p-6 rounded-xl shadow-lg">
                <h3 class="text-pink-200 text-sm font-semibold mb-1">Avg Retention</h3>
                <p class="text-4xl font-bold" id="avg-retention">0%</p>
            </div>
        </div>

        <!-- Actions -->
        <div class="mb-8 flex flex-wrap gap-3">
            <button onclick="showCreateModal()" class="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 px-6 py-3 rounded-lg font-semibold shadow-lg transition">
                ‚ñ∂Ô∏è Create New Video
            </button>
            <button onclick="loadVideos()" class="bg-gray-700 hover:bg-gray-600 px-6 py-3 rounded-lg font-semibold shadow-lg transition">
                üîÑ Refresh
            </button>
            <button onclick="showChannelsModal()" class="bg-purple-600 hover:bg-purple-700 px-6 py-3 rounded-lg font-semibold shadow-lg transition">
                üì∫ Manage Channels
            </button>
        </div>

        <!-- Videos Pipeline -->
        <div class="bg-gray-800 rounded-xl p-6 shadow-xl">
            <h2 class="text-3xl font-bold mb-6">Content Pipeline</h2>
            <div id="videos-container" class="space-y-6">
                <p class="text-gray-400 text-center py-8">Loading videos...</p>
            </div>
        </div>
    </div>

    <!-- Create Video Modal -->
    <div id="createModal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50">
        <div class="bg-gray-800 rounded-xl p-8 max-w-md w-full mx-4 shadow-2xl">
            <h3 class="text-2xl font-bold mb-6">Create New Video</h3>
            
            <div class="mb-4">
                <label class="block text-sm font-semibold mb-2">Channel</label>
                <select id="channelSelect" class="w-full bg-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="1">Main Channel</option>
                </select>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-semibold mb-2">Content Source</label>
                <select id="contentSource" class="w-full bg-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="trending">Trending Topics</option>
                    <option value="book">Book Chapter</option>
                    <option value="custom">Custom Topic</option>
                </select>
            </div>

            <div id="customTopicDiv" class="mb-6 hidden">
                <label class="block text-sm font-semibold mb-2">Custom Topic</label>
                <input type="text" id="customTopic" placeholder="Enter your topic..." class="w-full bg-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <div class="flex gap-3">
                <button onclick="createVideo()" class="flex-1 bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg font-semibold transition">
                    Create
                </button>
                <button onclick="hideCreateModal()" class="flex-1 bg-gray-700 hover:bg-gray-600 px-6 py-3 rounded-lg font-semibold transition">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Channels Modal -->
    <div id="channelsModal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50">
        <div class="bg-gray-800 rounded-xl p-8 max-w-2xl w-full mx-4 shadow-2xl max-h-[80vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-6">Manage Channels</h3>
            <div id="channelsList" class="space-y-3 mb-6"></div>
            <button onclick="hideChannelsModal()" class="w-full bg-gray-700 hover:bg-gray-600 px-6 py-3 rounded-lg font-semibold transition">
                Close
            </button>
        </div>
    </div>

    <script>
        let autoRefresh = null;

        async function loadStats() {
            const res = await fetch('/api/stats');
            const stats = await res.json();
            document.getElementById('total-videos').textContent = stats.total_videos;
            document.getElementById('ready-videos').textContent = stats.ready;
            document.getElementById('total-views').textContent = stats.total_views.toLocaleString();
            document.getElementById('avg-retention').textContent = (stats.avg_retention * 100).toFixed(1) + '%';
        }

        async function loadChannels() {
            const res = await fetch('/api/channels');
            const channels = await res.json();
            const select = document.getElementById('channelSelect');
            select.innerHTML = channels.map(ch => 
                `<option value="${ch.id}">${ch.name} (${ch.niche})</option>`
            ).join('');
        }

        async function loadVideos() {
            const res = await fetch('/api/videos');
            const videos = await res.json();
            const container = document.getElementById('videos-container');
            
            if (videos.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-8">No videos yet. Click "Create New Video" to start.</p>';
                return;
            }
            
            container.innerHTML = videos.map(video => `
                <div class="bg-gray-700 rounded-lg p-6 shadow-lg hover:shadow-xl transition">
                    <!-- Header -->
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <h3 class="font-bold text-xl mb-1">${video.title || video.topic || 'Untitled'}</h3>
                            <p class="text-sm text-gray-400">
                                üìÖ ${new Date(video.created_at).toLocaleString()} 
                                ${video.content_source ? `‚Ä¢ üìù ${video.content_source}` : ''}
                            </p>
                        </div>
                        <div class="flex gap-2">
                            <span class="px-3 py-1 rounded-full text-xs font-semibold ${getStatusColor(video.status)}">
                                ${video.status}
                            </span>
                        </div>
                    </div>

                    <!-- Progress Bar -->
                    <div class="mb-4">
                        <div class="flex justify-between text-xs text-gray-400 mb-2">
                            <span>${getStageLabel(video.stage)}</span>
                            <span>${video.stage_progress}%</span>
                        </div>
                        <div class="w-full bg-gray-600 rounded-full h-3 overflow-hidden">
                            <div class="progress-bar h-full bg-gradient-to-r from-blue-500 to-purple-600 rounded-full" 
                                 style="width: ${video.stage_progress}%"></div>
                        </div>
                    </div>

                    <!-- Stage Pipeline -->
                    <div class="flex justify-between items-center mb-4 px-2">
                        ${renderStageDots(video.stage, video.stage_progress)}
                    </div>

                    <!-- Actions -->
                    <div class="flex gap-2 flex-wrap">
                        ${video.video_path ? `<a href="/${video.video_path}" target="_blank" class="text-sm bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg transition">üìπ View Video</a>` : ''}
                        ${video.script ? `<button onclick="viewScript(${video.id})" class="text-sm bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg transition">üìÑ View Script</button>` : ''}
                        <button onclick="viewLogs(${video.id})" class="text-sm bg-gray-600 hover:bg-gray-500 px-4 py-2 rounded-lg transition">üìä View Logs</button>
                    </div>

                    ${video.error_log ? `
                        <div class="mt-4 p-3 bg-red-900/30 border border-red-700 rounded-lg">
                            <p class="text-xs text-red-300 font-mono">${video.error_log.substring(0, 200)}...</p>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function renderStageDots(currentStage, progress) {
            const stages = [
                { key: 'sourcing', icon: 'üîç', label: 'Source' },
                { key: 'script_generation', icon: 'üìù', label: 'Script' },
                { key: 'audio_generation', icon: 'üé§', label: 'Audio' },
                { key: 'video_generation', icon: 'üé¨', label: 'Video' },
                { key: 'metadata_generation', icon: 'üè∑Ô∏è', label: 'SEO' },
                { key: 'scheduling', icon: 'üìÖ', label: 'Schedule' },
                { key: 'completed', icon: '‚úÖ', label: 'Done' }
            ];

            const currentIndex = stages.findIndex(s => s.key === currentStage);
            
            return stages.map((stage, index) => {
                const isActive = index === currentIndex;
                const isCompleted = index < currentIndex || progress === 100;
                const color = isCompleted ? 'bg-green-500' : isActive ? 'bg-blue-500' : 'bg-gray-600';
                
                return `
                    <div class="flex flex-col items-center">
                        <div class="stage-dot ${isActive ? 'active' : ''} w-10 h-10 rounded-full ${color} flex items-center justify-center text-lg shadow-lg">
                            ${stage.icon}
                        </div>
                        <span class="text-xs mt-1 text-gray-400">${stage.label}</span>
                    </div>
                `;
            }).join('');
        }

        function getStageLabel(stage) {
            const labels = {
                'sourcing': 'Content Sourcing',
                'script_generation': 'Script Generation',
                'audio_generation': 'Audio Generation',
                'video_generation': 'Video Generation',
                'metadata_generation': 'Metadata Generation',
                'scheduling': 'Scheduling',
                'completed': 'Completed'
            };
            return labels[stage] || stage;
        }

        function getStatusColor(status) {
            const colors = {
                'pending': 'bg-yellow-600',
                'ready': 'bg-green-600',
                'uploaded': 'bg-blue-600',
                'failed': 'bg-red-600'
            };
            return colors[status] || 'bg-gray-600';
        }

        function showCreateModal() {
            document.getElementById('createModal').classList.remove('hidden');
            document.getElementById('createModal').classList.add('flex');
            loadChannels();
        }

        function hideCreateModal() {
            document.getElementById('createModal').classList.add('hidden');
            document.getElementById('createModal').classList.remove('flex');
        }

        function showChannelsModal() {
            document.getElementById('channelsModal').classList.remove('hidden');
            document.getElementById('channelsModal').classList.add('flex');
            loadChannelsList();
        }

        function hideChannelsModal() {
            document.getElementById('channelsModal').classList.add('hidden');
            document.getElementById('channelsModal').classList.remove('flex');
        }

        async function loadChannelsList() {
            const res = await fetch('/api/channels');
            const channels = await res.json();
            const container = document.getElementById('channelsList');
            container.innerHTML = channels.map(ch => `
                <div class="bg-gray-700 p-4 rounded-lg">
                    <h4 class="font-bold">${ch.name}</h4>
                    <p class="text-sm text-gray-400">Niche: ${ch.niche} ‚Ä¢ Status: ${ch.status}</p>
                </div>
            `).join('');
        }

        document.getElementById('contentSource').addEventListener('change', (e) => {
            const customDiv = document.getElementById('customTopicDiv');
            if (e.target.value === 'custom') {
                customDiv.classList.remove('hidden');
            } else {
                customDiv.classList.add('hidden');
            }
        });

        async function createVideo() {
            const channelId = document.getElementById('channelSelect').value;
            const contentSource = document.getElementById('contentSource').value;
            const customTopic = document.getElementById('customTopic').value;

            const payload = {
                channel_id: parseInt(channelId),
                content_source: contentSource
            };

            if (contentSource === 'custom' && customTopic) {
                payload.topic = customTopic;
            }

            const res = await fetch('/api/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await res.json();
            alert(data.message);
            hideCreateModal();
            
            // Start auto-refresh
            if (autoRefresh) clearInterval(autoRefresh);
            autoRefresh = setInterval(() => {
                loadVideos();
                loadStats();
            }, 3000);
        }

        async function viewScript(videoId) {
            const res = await fetch(`/api/video/${videoId}`);
            const video = await res.json();
            alert(video.script || 'No script available');
        }

        async function viewLogs(videoId) {
            const res = await fetch(`/api/video/${videoId}/logs`);
            const logs = await res.json();
            const logText = logs.map(log => 
                `[${new Date(log.timestamp).toLocaleTimeString()}] ${log.stage}: ${log.message}`
            ).join('\n');
            alert(logText || 'No logs available');
        }

        // Initial load
        loadStats();
        loadVideos();
        loadChannels();

        // Auto-refresh every 5 seconds
        setInterval(() => {
            loadStats();
            loadVideos();
        }, 5000);
    </script>
</body>
</html>
